@model RouteGeneratorViewModel
@{
    ViewData["Title"] = "Utilities - Route Generator";
}

<link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
<link rel="stylesheet" href="~/lib/leaflet-draw/leaflet.draw.css" />
<link rel="stylesheet" href="~/lib/easy-button/easy-button.css" />

<h1>Utilities</h1>

<p>@Html.ValidationMessage("Utilities", new { @class = "text-danger" })</p>

<h4>Route Generator</h4>

<p>
    Leaflet based map to manually create, automatically generator, or optimize coordinate routes as well as boundary geofences.
</p>

<br />
@Html.DisplayFor(model => model, "Breadcrumbs", new { Controller = "Utilities", ControllerText = "Utilities", CurrentPage = "Route Generator" })

<hr />

<button type="button" class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#exportModal">
    Export Geofence
</button>
<br />
<br />

<div id="map" style="height: 600px;"></div>

@await Html.PartialAsync("_ImportGeofenceRouteModalPartial", new GeofenceRouteViewModal
{
    Format = "json",
    Title = "Import Geofence",
    Geofence = "",
    FormatChangedMethod = "importFormatChanged(this);",
    SubmitButtonText = "Import",
    SubmitButtonMethod = "importGeofence();",
});

@await Html.PartialAsync("_ExportGeofenceRouteModalPartial", new GeofenceRouteViewModal
{
    Title = "Export Geofence",
    Format = "json",
    Geofence = "",
    FormatChangedMethod = "exportFormatChanged(this);",
    SubmitButtonText = "Copy to Clipboard",
    SubmitButtonMethod = "exportGeofence();",
});

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script src="~/lib/leaflet/leaflet.js"></script>
<script src="~/lib/leaflet-draw/leaflet.draw.js"></script>
<script src="~/lib/easy-button/easy-button.js"></script>
<script src="~/js/clipboard.js"></script>
<script src="~/js/geofence-converters.js"></script>
<script>
    let importFormat = 'json';
    const map = L.map('map').setView([34.01, -117.01], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const shapeOptions = {
        stroke: true,
        color: '#3388ff',
        weight: 3,
        opacity: 1,
        fill: true,
        fillColor: null,
        fillOpacity: 0.2,
    };

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
        },
        draw: {
            polyline: false,
            polygon: {
                allowIntersection: true,
                showArea: true,
                metric: 'km',
                precision: {
                    km: 2,
                },
                shapeOptions,
            },
            rectangle: {
                showRadius: true,
                metric: true,
                shapeOptions,
            },
            circle: false,
            marker: false,
            circlemarker: false,
        },
    });
    map.addControl(drawControl);

    L.easyButton({
        states: [{
            icon: 'fa-solid fa-file-import',
            title: 'Import geofence',
            onClick: (button, map) => $('#importModal').modal('show'),
        }]
    }).addTo(map);

    L.easyButton({
        states: [{
            icon: 'fa-solid fa-trash-can',
            title: 'Delete all layers',
            onClick: (button, map) => {
                if (window.confirm('Are you sure you want to delete all shapes?')) {
                    drawnItems.clearLayers();
                }
            },
        }]
    }).addTo(map);

    map.on('draw:created', (e) => {
        //console.log('onCreated:', e);
        const layer = e.layer;
        if (drawnItems) {
            drawnItems.addLayer(layer);
        }
    });

    $('#exportModal').on('shown.bs.modal', () => {
        const geofence = drawnItems.toGeoJSON();
        const json = JSON.stringify(geofence, null, 2);
        $('#exportModal #Geofence').val(json);
    });

    const importFormatChanged = (e) => importFormat = e.value;

    const importGeofence = () => {
        const geofenceData = $('#importModal #Geofence').val();
        if (!geofenceData) {
            return;
        }

        const geofence = formatGeofenceToGeoJson(importFormat, geofenceData);
        loadGeofence(geofence);
        $('#importModal').modal('hide');
    };

    const exportFormatChanged = (e) => {
        const exportFormat = e.value;
        const geofence = $('#exportModal #Geofence').val();

        switch (exportFormat) {
            case 'json':
                // Convert ini to json geofence
                const geojson = iniToGeoJson(geofence);
                const json = JSON.stringify(geojson, null, 2);
                //console.log('json:', json);
                $('#exportModal #Geofence').val(json);
                break;
            case 'txt':
            case 'ini':
                // Convert json to ini geofence
                const iniData = [];
                drawnItems.eachLayer(layer => {
                    const geojson = layer.toGeoJSON();
                    const data = geoJsonToIni(geojson);
                    iniData.push(data);
                });
                const ini = iniData.join('');
                //console.log('ini:', ini);
                $('#exportModal #Geofence').val(ini);
                break;
        }
    };

    const exportGeofence = () => {
        const geofence = $('#exportModal #Geofence').val();
        if (geofence) {
            copyToClipboard(geofence);
        }
    };

    const formatGeofenceToGeoJson = (format, data) => {
        //console.log('format:', format, 'data:', data);
        if (data.length === 0) {
            return null;
        }
        if (typeof data === 'object') {
            return data;
        }
        switch (format) {
            case 'json':
                return JSON.parse(data);
            case 'txt':
            case 'ini':
                return iniToGeoJson(data);
            default:
                throw Error('Unsupported geofence format');
        }
    };

    const loadGeofence = (data) => {
        if (!drawnItems) {
            return;
        }
        const leafletGeoJSON = new L.GeoJSON(data);
        leafletGeoJSON.eachLayer(layer => {
            // TODO: Get area size of geofence
            const html = `
            <b>Name:</b> ${layer.feature.properties.name}<br>
            <b>Area:</b> ${0} km2
`;
            layer.bindTooltip(html);
            drawnItems.addLayer(layer);
        });
    };
</script>
}